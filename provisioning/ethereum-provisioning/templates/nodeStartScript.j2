#!/bin/bash
ACC_FILE=$(find {{ SIGNER_DIR }}/keystore/ -type f | head -1) && PRIVATE_CONFIG=ignore nohup {{ BUILD_PATH }}/geth --datadir /nodes/node-{{ item }} {% if CONSENSUS_NAME == "clique" %}--unlock $(cat $ACC_FILE | jq -r .address && cp $ACC_FILE /nodes/node-{{ item }}/keystore/) --miner.etherbase=0x$(cat $ACC_FILE | jq -r .address && rm $ACC_FILE) --password passwordfile.txt{% endif %} --nodiscover --gcmode {{ GCMODE }} --verbosity {{ LOGGING_VERBOSITY }} --networkid {{ NETWORK_ID }} --syncmode {{ SYNCMODE }} --maxpeers {{ MAXPEERS }} {% if (hostvars[inventory_hostname]['signer'] is defined and hostvars[inventory_hostname]['signer'] | bool ) or CONSENSUS_NAME == "ethash" %}--mine{% endif %} --miner.threads {{ NUMBER_OF_MINER_THREADS }} --allow-insecure-unlock --http --http.addr 0.0.0.0 --http.vhosts=* --http.port {{ RPC_START_PORT + groups['node'].index(inventory_hostname) * 100 + my_idx }} --http.api {{ PLUGINS }} --ws --ws.addr 0.0.0.0 --ws.port {{ WS_START_PORT + groups['node'].index(inventory_hostname) * 100 + my_idx }} --ws.api {{ PLUGINS }} --ws.origins=* --nat {{ NAT_MODE }} --miner.gastarget {{ GASTARGET }} --miner.gaslimit {{ GASLIMIT }} {% if ENABLE_METRICS %} --metrics --metrics.influxdb --metrics.influxdb.endpoint "http://{{ INFLUX_HOST }}:8086" --metrics.influxdb.database {{ INFLUX_DATABASE }} --metrics.influxdb.username {{ INFLUX_USERNAME }} --metrics.influxdb.password {{ INFLUX_PASSWORD }} --metrics.influxdb.tags node-{{ item }}-{{ inventory_hostname }} {% endif %} --rpc.gascap {{ GASCAP }} --rpc.txfeecap {{ TXFEECAP }} --port {{ P2P_START_PORT + groups['node'].index(inventory_hostname) * 100 + my_idx }} --txpool.pricelimit {{ PRICELIMIT }} --txpool.pricebump {{ PRICEBUMP }} --txpool.accountslots {{ ACCOUNTSLOTS }} --txpool.globalslots {{ GLOBALSLOTS }} --txpool.accountqueue {{ ACCOUNTQUEUE }} --txpool.globalqueue {{ GLOBALQUEUE }} --miner.gasprice {{ GASPRICE }} --rpc.evmtimeout {{ EVM_TIMEOUT }} {% if MINER_NOVERIFY %}--miner.noverify{% endif %} >> /nodes/node-{{ item }}/node.log 2>&1 &
